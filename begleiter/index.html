<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Begleiter ¬∑ Plan &amp; Reflexion</title>
    <style>
      :root { --muted:#6b7280; --border:#e5e7eb; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif; max-width: 860px; margin: 40px auto; padding: 0 16px; line-height: 1.6; }
      h1 { margin-bottom: .2em }
      .muted { color: var(--muted); }
      .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
      textarea, input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; min-height: 84px; font-family: inherit; }
      .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
      button { padding: 10px 14px; border:1px solid #d1d5db; border-radius: 10px; background:#fff; cursor:pointer; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      .pill { background:#f3f4f6; border-radius:999px; padding:6px 10px; font-size:.9rem; }
      .notice { background:#f9fafb; border:1px dashed #d1d5db; border-radius:12px; padding:12px; }
      .section { border:1px solid var(--border); border-radius:12px; padding:14px; }
      .small { font-size:.92rem }
      pre { background:#f6f8fa; padding:10px; border-radius:10px; overflow:auto; }
      @media (min-width: 720px) {
        .grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <h1>ü§ñ Begleiter</h1>
    <p class="muted">Sanfter Tagesbogen: <strong>Plan</strong> am Morgen, <strong>Reflexion</strong> am Abend. Alles bleibt <em>nur auf diesem Ger√§t</em>.</p>

    <div class="grid">
      <!-- Journal-Eingaben: werden pro Datum in localStorage unter "vlfl_journal" gespeichert -->
      <div class="section">
        <div class="row" aria-live="polite">
          <span class="pill" id="today" title="Heutiges Datum"></span>
          <span class="muted small">Empfehlung: 5‚Äì10 Minuten reichen. Kein Druck.</span>
        </div>
        <label for="plan"><strong>Morgens ‚Äì Plan (grob)</strong></label>
        <textarea id="plan" placeholder="Was ist heute wesentlich? (3 Punkte gen√ºgen)"></textarea>

        <label for="reflect"><strong>Abends ‚Äì Reflexion (frei)</strong></label>
        <textarea id="reflect" placeholder="Was war echt? Was hat getragen? Eine Sache, die ich mitnehme."></textarea>

        <div class="row">
          <button id="save" aria-label="Eintrag speichern">Speichern</button>
          <button id="export" aria-label="Daten exportieren">Export (.json)</button>
          <input type="file" id="import" accept="application/json" style="display:none" />
          <button id="importBtn" aria-controls="import">Import</button>
          <span class="muted small" id="status" role="status" aria-live="polite"></span>
        </div>
      </div>

      <!-- Artefakt: klein & freundlich; ohne KI (Keyword-Set) oder optional mit lokaler KI (Ollama) -->
      <div class="section">
        <h3>üéÅ Artefakt (optional, sanft)</h3>
        <p class="small">Aus deiner Reflexion entsteht hier eine kleine Geste (Wort, Bild-Idee, Mini-Ritual). Ohne Zwang. Mit oder ohne KI.</p>
        <div class="row">
          <button id="makeArtifact">Ohne KI erzeugen</button>
          <button id="aiArtifact">Mit lokaler KI (Ollama)</button>
          <span id="aiState" class="small muted"></span>
        </div>
        <pre id="artifactBox">Noch nichts erzeugt.</pre>
      </div>

      <div class="section notice small">
        <strong>Privat & gesund:</strong>
        <ul>
          <li>Keine Pflicht, keine Streaks. Pausen sind okay.</li>
          <li>Alles bleibt lokal (Browser-Speicher). Du entscheidest, was du teilst.</li>
          <li>Auf √∂ffentlichen Seiten (HTTPS, z. B. GitHub Pages) ist KI standardm√§√üig aus. Lokal kannst du sie aktivieren.</li>
        </ul>
      </div>
    </div>

    <p><a href="../index.html">‚Üê Zur√ºck zur Startseite</a></p>

    <script>
      // --- Helpers & Storage -----------------------------------------------
      const $ = sel => document.querySelector(sel);
      const todayStr = new Date().toISOString().slice(0,10);
      $("#today").textContent = todayStr;

      function loadStore() {
        try { return JSON.parse(localStorage.getItem('vlfl_journal') || '{}'); }
        catch(e){ return {}; }
      }
      function saveStore(obj) {
        localStorage.setItem('vlfl_journal', JSON.stringify(obj));
      }

      // Lade aktuellen Eintrag
      const store = loadStore();
      const entry = store[todayStr] || {};
      $("#plan").value = entry.plan || "";
      $("#reflect").value = entry.reflect || "";

      // Speichern
      $("#save").onclick = () => {
        const s = loadStore();
        s[todayStr] = {
          plan: $("#plan").value.trim(),
          reflect: $("#reflect").value.trim(),
          insight: (s[todayStr]?.insight || ""),
          artifact: (s[todayStr]?.artifact || "")
        };
        saveStore(s);
        $("#status").textContent = "Gespeichert.";
        setTimeout(()=> $("#status").textContent = "", 2000);
      };

      // Export
      $("#export").onclick = () => {
        const data = localStorage.getItem('vlfl_journal') || "{}";
        const blob = new Blob([data], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "journal-export.json";
        a.click();
        URL.revokeObjectURL(a.href);
      };

      // Import
      $("#importBtn").onclick = () => $("#import").click();
      $("#import").addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
          const text = await file.text();
          const obj = JSON.parse(text);
          if (!obj || typeof obj !== 'object' || Array.isArray(obj)) throw new Error("Kein Objekt.");
          saveStore(obj);
          $("#status").textContent = "Import OK. Seite neu laden, um Daten zu sehen.";
        } catch (err) {
          $("#status").textContent = "Import fehlgeschlagen.";
          console.error(err);
        }
      });

      // --- Artefakt ohne KI -------------------------------------------------
      // Einfaches Kartenset + Stichwortsuche; bewusst simpel & lokal
      const cards = [
        {key:"Klarheit", prompt:"Ein Satz, der es einfacher macht.", ritual:"Fenster auf, 3 tiefe Atemz√ºge."},
        {key:"Mut", prompt:"Ein kleiner Schritt, der dich heute n√§hert.", ritual:"1 Nachricht an eine Person, die dir gut tut."},
        {key:"Leichtigkeit", prompt:"Wor√ºber kannst du heute l√§cheln?", ritual:"5 Minuten Musik & bewegen."},
        {key:"Ordnung", prompt:"Was bekommt heute einen festen Platz?", ritual:"2 Minuten aufr√§umen in einem Mini-Bereich."},
        {key:"Dankbarkeit", prompt:"Wof√ºr bist du heute dankbar?", ritual:"Notiere 3 Dinge handschriftlich."}
      ];
      function pickArtifact(text) {
        // Primitive Auswahl: suche Stichworte, sonst zuf√§llig
        const t = (text||"").toLowerCase();
        const map = { klar:0, fokus:0, mut:1, angst:1, leicht:2, humor:2, ordn:3, chaos:3, dank:4 };
        let idx = null;
        for (const k in map) { if (t.includes(k)) { idx = map[k]; break; } }
        if (idx === null) idx = Math.floor(Math.random()*cards.length);
        const c = cards[idx];
        return `ÔøΩ ${c.key}\n‚Ä¢ Hinweis: ${c.prompt}\n‚Ä¢ Mini-Ritual: ${c.ritual}`;
      }

      $("#makeArtifact").onclick = () => {
        const s = loadStore();
        const txt = $("#reflect").value || $("#plan").value || "";
        const artifact = pickArtifact(txt);
        $("#artifactBox").textContent = artifact;
        s[todayStr] = { ...(s[todayStr]||{}), artifact, insight: (s[todayStr]?.insight || "") };
        saveStore(s);
      };

      // --- Optional: lokale KI via Ollama ----------------------------------
      // Aktiv nur, wenn Seite NICHT via HTTPS l√§uft (gem√§√ü Mixed-Content-Regeln)
      const aiInfo = $("#aiState");
      const aiBtn = $("#aiArtifact");

      function isHttps() { return location.protocol === "https:"; }
      function localAIEnabledByContext() { return !isHttps(); }

      if (!localAIEnabledByContext()) {
        aiInfo.textContent = "KI lokal ist auf HTTPS-Seiten deaktiviert (Sicherheitsgr√ºnde). Starte lokal √ºber einen Dev-Server.";
        aiBtn.disabled = true;
      } else {
        aiInfo.textContent = "Optional: Ollama lokal (http://localhost:11434).";
      }

      async function callOllamaChat(userText) {
        const res = await fetch("http://localhost:11434/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "gemma3:1b",
            stream: false,
            messages: [
              { role: "system", content: "Du bist ein sanfter, verantwortungsvoller Reflexionspartner. Antworte kurz, respektvoll und konkret."},
              { role: "user", content: userText }
            ]
          })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        return data?.message?.content || JSON.stringify(data);
      }

      aiBtn.onclick = async () => {
        aiBtn.disabled = true;
        aiInfo.textContent = "Verbinde mit Ollama ...";
        try {
          const base = $("#reflect").value || $("#plan").value || "";
          const prompt = base.trim() ? base.trim() : "Gib mir eine liebevolle, kurze Tages-Geste als Artefakt.";
          const ask = "Erzeuge eine kleine, freundliche Geste (Artefakt) basierend auf meiner kurzen Notiz. maximal 3 Zeilen. Form: Titel, Hinweis, Mini-Ritual. Notiz: " + prompt;
          const text = await callOllamaChat(ask);
          $("#artifactBox").textContent = text;
          const s = loadStore();
          s[todayStr] = { ...(s[todayStr]||{}), artifact: text, insight: (s[todayStr]?.insight || "") };
          saveStore(s);
          aiInfo.textContent = "OK.";
        } catch (err) {
          aiInfo.textContent = "Fehler bei lokaler KI (siehe Konsole).";
          console.error(err);
        } finally {
          aiBtn.disabled = false;
        }
      };
    </script>

    <!--
      Hinweise (CORS / Mixed-Content):
      - Auf HTTPS-Seiten blocken Browser HTTP-Requests zu http://localhost:11434 (Mixed Content). Deshalb ist der KI-Button auf HTTPS deaktiviert.
      - Lokal testen: Seite √ºber einen lokalen Server √∂ffnen (http://...), dann funktioniert die Anfrage zu Ollama (sofern auf 11434 gestartet).
      - Export/Import nutzt lokale Dateien, die niemals das Ger√§t verlassen.
    -->
  </body>
</html>
